# What is LoRa/LoRaWAN???

## 1. LoRa : wireless MODULATION used to create long-range communication link (End Device)

- https://medium.com/kgxperience/what-happens-in-lora-lorawan-communication-ab32d56dfc71
- made by Semtech
- Physical Layer protocol
- Chirp Spread Spectrum(CSS) Modulation : 915MHz(USA)
    - low-frequency modulation
    - higher sensitivity → enabling long-distance connectivity
    - 8 up chirps followed by 2 down chirps… and then data
- Power (Watt, W)
    - RF signal can be measured by Watt (W) using amplitude
    - $dBm = 10log^P(P : power, W)$
- Receive Sensitivity a minimum power that can receive signal
    - LoRa receiver is really sensitive, down to -148dBm
- RSSI (Received Signal Strength Indicator) ( - dBm; absolute)
    - https://www.thethingsnetwork.org/docs/lorawan/rssi-and-snr/
    - received signal strength, receive power, check if signal strength is strong enough to get a good wireless communication
    - LoRa에서는 RSSI = -30dBm: strong, RSSI = -120dBm: weak
    - help to determine if the received signal is strong enough to get a good wireless connection
    - important for both gateways and end devices
    - closer to zero → received signal is stronger
    - influenced by Path loss, Antenna gain, Cable/connector loss
- SNR (Signal-to-Noise Ratio) (dB; relative)
    - demodulation의 기준이 되는 신호의 quality
    - LoRa에서는 -20dB and +10dB 사이
    - ratio of the received signal power to the noise floor
    - commonly used to determine the quality of the received signal
    - SNR(dB) = RSSI(dBm) - noise floor(dBm)
        - noise floor : amount of noise generated by the device
    - if the RSSI is above the noise floor(= positive SNR), the receiver can easily demodulate the signal
        
        <img width="678" alt="Screenshot 2024-01-18 at 9 36 35 AM" src="https://github.com/JeongHwaSik/KSW_LoRa/assets/99574746/f4a10f93-1208-49a5-b4f6-c17dfd259dc9">
        
    - if negative SNR, it is impossible to demodulate the signal BUT LoRa CAN!!!
        
        <img width="678" alt="Screenshot 2024-01-18 at 9 35 58 AM" src="https://github.com/JeongHwaSik/KSW_LoRa/assets/99574746/c6d02339-b839-4ef4-92dc-94b4869d8d53">
        
- Transmission Parameters
    - carrier frequency (CF)
        - just frequency
        - different frequencies + other info. → channels
        - LoRa는 각각의 message마다 random하게 channel을 지정함
        - 하나의 channel에 대응되는 BW와 SF가 존재함
    - bandwidth (BW) = chip rate (chips/sec = Hz)
        - range from CF - (1/2)BW to CF + (1/2)BW
        - 125kHz, 250kHz, 500kHz,
        - BW ⬆ → DR ⬆ → ToA ⬇
    - 🌟🌟🌟SPREADING FACTOR (SF)
        - https://blog.ttulka.com/lora-spreading-factor-explained/
        - 주어진 channel의 BW내에서 frequency의 변화 속도, Signal의 특성
        - speed at which the signal frequency changes across the bandwidth of a channel in the time unit
        - distance ⬆ → SF ⬆ → DR ⬇ → data sent slowly → ToA ⬆ → SNR ⬆  → receiver sensitivity ⬆
        - different SF → orthogonal = received concurrently
        - SF ⬆ → receiver sensitivity ⬆
        - 🌟신호의 세기(RSSI)가 weak → SF ⬆ → receiver sensitivity ⬆, 즉 weak한 신호라도 receiver에서 받을 수 있음
        - for each SF, there is a SNR limit(∵demodulation을 해야하기 때문)
            
            <img width="634" alt="Screenshot 2024-01-18 at 9 33 37 AM" src="https://github.com/JeongHwaSik/KSW_LoRa/assets/99574746/4d51838c-2555-4a84-9aba-3a3710d08c5b">
            
            - Ex. SF=7의 signal일 때 SNR이 -7.5dB보다 작으면 demodulation 불가능
            - Receiver Sensitivity(S)는 BW, NF(receiver Noise Figure), SNR_limit에 의해 계산가능
                - https://www.youtube.com/watch?v=NSjHWQMg6yo&list=PLmL13yqb6OxdeOi97EvI8QeO8o-PqeQ0g&index=16
                - NF는 hardward implementation에 의해 고정
                - SNR_limit은 SF에 의해 달라짐
                
                <img width="597" alt="Screenshot 2024-02-16 at 2 55 30 PM" src="https://github.com/JeongHwaSik/KSW_LoRa/assets/99574746/2bd6a932-ef26-4d69-b0ee-c6b6616a91ab">
                <img width="543" alt="Screenshot 2024-02-16 at 2 54 24 PM" src="https://github.com/JeongHwaSik/KSW_LoRa/assets/99574746/0093ca98-b51d-472d-b595-0622e994deaf">
                
                
    - coding rate (CR)
        - $CR = 4 / (4 + CR), CR = 1, 2, 3, 4$
        - proportion of the transmitted bits that actually carries info.
        - rest of them are for error correction
- half-duplex; bidirectional but not simultaneous
- reduce the amount of energy consumption

— by using asynchronous communication; end nodes only sends data when it is scheduled to ‘wake up’ or has data to send

- duty cycle
    - Ex. total allowed uplink ToA is 86400 sec(= one day) * 1% duty cycle = 864 seconds per day, per device

- some other metrics
    - Chip Rate = BW
    - Symbol Rate
    - Data Rate (DR; bits / sec)
        - also called Bit Rate (bits/sec)
        - computed by Bandwidth(BW), Spreading Factor(SF), Coding Rate(CR)
            
            <img width="296" alt="Screenshot 2024-01-29 at 10 15 11 AM" src="https://github.com/JeongHwaSik/KSW_LoRa/assets/99574746/3e94f87e-4178-40da-9aee-198472602c05">
            
        - BW ⬆ → DR ⬆
        - distance ⬆ → SF ⬆ → DR ⬇
        - CR ⬆ → DR ⬇
- 🌟Adaptive Data Rate (ADR)
    
    - https://lora-developers.semtech.com/documentation/tech-papers-and-guides/understanding-adr
    
    - https://www.youtube.com/watch?v=C_Rh5GSENA4&list=PLmL13yqb6OxdeOi97EvI8QeO8o-PqeQ0g&index=17
    
    - goal : minimize energy consumption, maximize throughput
    - distance ⬇ → power ⬇ → SF ⬇ → DR ⬆
    - only for fixed end node
    - network server에서 받은 20개의 uplink message 중 maximum SNR(SNR_measured)을 고름, for less power
    - margin을 최소화하는 방향으로 SF, BW, Transmission power, CR 설정
        - $margin = SNRmeasured - SNRlimit-default margin$
    - US902-928 : SF7BW125 ~ SF10BW125


## 2. LoRaWAN : networking PROTOCOL that delivers secure bi-directional communication defined by Lora Alliance

- on top of LoRa technology, the LoRa Alliance has developed open-source protocol
- MAC(Media Access Control) Layer protocol
- provide LoRa …
    - Adaptive Data Rate (ADR)
    - Security
    - GPS-free Geolocation
    - Channel Access
    - Energy Saving functionalities
- three channel access strategies
    
    ; trade-off between performance(throughput, latency) and energy consumption
    
    - class A devices
    
    : default, least power consumption, AHOLA
    
    - class B devices
    
    : periodic wake ups
    
    - class C devices
    
    : really power intensive, receiver is always on
    
- can also be a network server


## 3. Fundamental Components

- End Nodes
    - radio module with antenna + microprocessor for sensor
    - does not allow direct communication between end nodes (but can do by using RadioHead Packet Radio library)
- Gateways (Concentrators)
    - operates on physical layer
    - demodulate the LoRa packets
    - nothing but LoRa radio message forwarders to LNS (LoRaWAN Network Server)
    - single-channel gateways vs. multi-channel gateways (channels = frequencies)
    - radio module with antenna + microprocessor for data
    - can listen to multiple frequencies simultaneously
- Network Server (LNS)
    - like the router(which application server) of the LoRaWAN protocol
    - manages entire network
    - ensures authenticity of every sensor and message
    - performs uplink de-duplication, deleting all copies based on RSSI (Received Signal Strength Indicator)
    - schedules downlink messages
    - handles JOIN request and JOIN accept messages between device and Join server
- Application Server
    - receives frame from the Network server and decrypt the data
    - encrypts the data and send the downlinks to the end nodes
    - AWS, MQTT broker, HTTP, Dashboards etc
- Join Server
    - an end device must first be activated before it is able to communicate with the network server
    - activation methods
        - Over-The-Air-Activation (OTAA)
            - Join procedure to exchange keys securely
            - end devices store
                1. DevEUI - similar to HW MAC address
                2. AppEUI - to encrypt and decrypt message, similar to a port number
                3. AppKey - to check integrity of message
                    1. Device address; DevAddr
                    2. Network Session key; NwkSKey
                    3. Application Session key; AppSKey
            - network server know : AppKey
            
            <img width="868" alt="Screenshot 2024-01-23 at 2 22 24 PM" src="https://github.com/JeongHwaSik/KSW_LoRa/assets/99574746/1e727fd5-1e1b-4b82-b1ae-c2868b78e03a">
            <img width="786" alt="Screenshot 2024-01-23 at 2 15 51 PM" src="https://github.com/JeongHwaSik/KSW_LoRa/assets/99574746/9ac84670-e812-48e5-9afe-a6d7af94dcfc">
            
        - Activation-By-Personalization (ABP)
    - used in the Over the Air Activation(OTAA) commissioning process

## 4. Overview of LoRa/LoRaWAN

<img width="1392" alt="Screenshot 2024-03-03 at 4 52 37 PM" src="https://github.com/JeongHwaSik/KSW_LoRa/assets/99574746/c1b14527-0727-4a79-b0fa-e97ad2d20894">
